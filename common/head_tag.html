<script type="text/discourse-plugin" version="0.8">
  const { h } = require('virtual-dom');
  const { getOwner } = require('discourse-common/lib/get-owner');

  const query = `
    query coursesForCategory($slug: String!) {
      catalog {
        category(slug: $slug) {
          courses {
            difficulty,
            lessonCount,
            pro,
            title,
            url
          }
        }
      }
    }
  `;
  
  const fetchCourseData = (slug) => {
    const normalizedSlug = slug.toLowerCase();

    return fetch('https://www.codecademy.com/graphql', {
      method: 'POST',
      mode: 'cors',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
        'CF-Access-Client-Id': 'ad16bb2b778ae121cd412e5e590e180a.access',
        'CF-Access-Client-Secret': 'ab97fb0c22b3bfc02fa58d7cd6604e4f248e49d24ab1370da6c38afc32b0caa1',
      },
      body: JSON.stringify({
        query,
        variables: { slug: normalizedSlug },
        operationName: 'coursesForCategory',
      }),
    });
  };
  
  const renderCard = (cardData) =>
    h('a.codecademy-card', { href: cardData.url, target: '_blank' }, [
      h('div.codecademy-card__type', [
        cardData.pro ? h('span.codecademy-card__pro-badge', 'pro') : '',
        'Course',
      ]),
      h('h4.codecademy-card__title', cardData.title),
      h('div.codecademy-card__difficulty', [
        cardData.difficulty === 'Beginner' ? '●○ Beginner friendly, ' : '●● Intermediate, ',
        h('b', cardData.lessonCount),
        'lessons',
      ]),
    ]);
  
  api.createWidget('codecademy-related-content', {
    tagName: 'div.codecademy-mount-point',

    buildKey: () => 'codecademy-related-content',

    defaultState() {
      return {
        data: [],
        slug: '',
      };
    },

    html(_, state) {
      const container = Discourse.__container__;
      const controller = container.lookup('controller:topic');
      const categoryId = controller.get('model.category_id');
      
      this.appEvents.on('page:changed', () => {
        this.state.slug = controller.get(`model.site.categoriesById.${categoryId}.name`);

        fetchCourseData(state.slug)
          .then((res) => res.json())
          .then((json) => {
            this.state.data = json?.data?.catalog?.category?.courses?.slice(0, 2);
            this.scheduleRerender();
          });
      });

      return state.data.length ? 
        h('div', [
          h('h3', `Learn ${state.slug || 'More'} on Codecademy`),
          h('div.codecademy-cards', state.data.map((cardData) => renderCard(cardData))),
        ]) : null;
    }
  });
</script>

<!-- bottom of each topic page -->
<script type="text/x-handlebars" data-template-name="/connectors/below-suggested-topics/codecademy-related-content">
  {{mount-widget widget="codecademy-related-content"}}
</script>
