<script type="text/discourse-plugin" version="0.8">
  const { h } = require('virtual-dom');
  const { ajax } = require('discourse/lib/ajax');
  const { getOwner } = require('discourse-common/lib/get-owner');
  
  const mockData = [
    {
      title: 'Test title',
      proExclusive: false,
      difficulty: 0,
      contentItemCount: 6,
      type: 'course',
      path: 'https://codecademy.com',
    }, {
      title: 'Other test title',
      proExclusive: true,
      difficulty: 1,
      contentItemCount: 420,
      type: 'path',
      path: 'https://codecademy.com',
    }
  ];

  const query = `
    query coursesForCategory($slug: String!) {
      category(slug: $slug) {
        tracks {
          title
          proExclusive
          difficulty
          contentItemCount
        }
      }
    }
  `;
  
  const fetchCourseData = (slug) => {
    return ajax('https://contentv4.staging-eks.codecademy.com/graphql', {
      type: 'POST',
      headers: { 'Content-Type': 'application/json' },
      data: {
        query,
        variables: { slug },
        operationName: 'coursesForCategory',
      },
    });
  };
  
  const renderCard = (cardData) =>
    h('a.codecademy-card', { href: cardData.path, target: '_blank' }, [
      h('div.codecademy-card__type', [
        cardData.proExclusive ? h('span.codecademy-card__pro-badge', 'pro') : '',
        cardData.type,
      ]),
      h('h4.codecademy-card__title', cardData.title),
      h('div.codecademy-card__difficulty', [
        cardData.difficulty ? '●● Intermediate, ' : '●○ Beginner friendly, ',
        h('b', cardData.contentItemCount),
        'lessons',
      ]),
    ]);
  
  api.createWidget("codecademy-related-content", {
    tagName: "div.codecademy-mount-point",

    defaultState() {
      return { data: mockData };
    },

    html() {
      const container = Discourse.__container__;
      const controller = container.lookup('controller:topic');
      const categoryId = controller.get('model.category_id');
      
      const slug = controller.get(`model.site.categoriesById.${categoryId}.name`);

      this.appEvents.on("page:changed", () => {
        fetchCourseData(slug).then((res) => {
          this.state.data = res;
          this.scheduleRerender();
        });
      });
      
      return h('div', [
        h('h3', `Learn ${slug || 'More'} on Codecademy`),
        h('div.codecademy-cards', this.state.data.map((cardData) => renderCard(cardData))),
      ]);
    }
  });
</script>

<!-- bottom of each topic page -->
<script type="text/x-handlebars" data-template-name="/connectors/below-suggested-topics/codecademy-related-content">
  {{mount-widget widget="codecademy-related-content"}}
</script>
